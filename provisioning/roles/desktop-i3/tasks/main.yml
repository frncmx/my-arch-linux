---

- name: Install the X Display Server
  pacman: >
    name={{ item }}
    state=present
    update_cache=yes
  with_items:
  - xorg
  - xorg-xinit # .xinitrc, startx

- name: Install i3 group
  pacman: >
    name={{ item }}
    state=present
    update_cache=yes
  with_items:
  - i3-wm
  - i3lock
  - i3status

- name: Install basic utils for Desktop
  pacman: >
    name={{ item }}
    state=present
    update_cache=yes
  with_items:
  - dmenu       # Mod + d => slect app to lunch
  - xclip       # A working clipboard for X
  - alsa-utils  # Contains amixer for sound shortcuts (.i3/config)

- name: Install i3cat for custom status items on status bar
  command: >
    yaourt -Sy --noconfirm i3cat-git
    creates=/usr/bin/i3cat
  become_user: yaourt

- name: Install small utility to read current keyboard layout
  command: >
    yaourt -Sy --noconfirm xkblayout-state
    creates=/usr/bin/xkblayout-state
  become_user: yaourt

- name: Create i3 config directory in /etc/skel
  file: >
    path=/etc/skel/.i3
    state=directory

- name: Add default config files to /ets/skel/.i3
  copy: >
    src={{ item.name }}
    dest=/etc/skel/.i3/{{ item.name }}
    mode={{ item.mode }}
  with_items:
  - { name: 'config', mode: '0644' }
  - { name: 'i3cat.conf', mode: '0644' }
  - { name: 'status.conf', mode: '0644' }
  - { name: 'status-caps-is-on', mode: '0744' }
  - { name: 'status-current-layout', mode: '0744' }

- name: Put .xinitrc into /etc/skel
  copy: >
    src=xinitrc
    dest=/etc/skel/.xinitrc
    mode=0644

  # TODO: Brake dependency for base::bash::bash_login
- name: Start X on tty1 login
  blockinfile:
    dest: /etc/skel/.bash_login
    block: |
      if [[ "$(tty)" == '/dev/tty1' ]]; then
        # Start i3-wm if it's not running.
        pidof i3 &> /dev/null || startx
      fi
    backup: yes

- include: network-manager.yml
